<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lobby</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <link rel="stylesheet/less" type="text/css" href="stylesheets/game.less">
    <script src="/less.min.js" type="text/javascript"></script>
    <script src="jquery.md5.js" type="text/javascript"></script>
    <script src="jquery.touchclick.min.js" type="text/javascript"></script>
    <script src="jquery.tools.min.js" type="text/javascript"></script>
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect('http://' + location.host + '/chat');

        var users = {};
        var me = null;


        /**
         User Model
         Repsresents a User
         @param string nick: nickname
         */
        function User(nick) {
            this.fights = false;
            this.name = nick;

            this.startFight = function() {
                this.fights = true;
            }
            this.finishedFight = function() {
                this.fights = false;
            }
        }

        /* GENERAL */
        function enc(object) { return JSON.stringify(object); }
        function dec(str) { return JSON.parse(str); }

        function doLog(level, title, msg) {
            console.log(title + ": " + enc(msg));
        }

        function log(title, msg) {
            doLog("DEBUG", title, msg);
        }

        function err(title, msg) {
            doLog("ERROR", title, msg);
        }

        function show(text, user) {
            if (user != null) text = user + ": " + text;
            // doLog("DEBUG", "Write", text);
            var $out = $("#messages");
            $out.val($out.val() + text + "\n");
            $out.scrollTop($out[0].scrollHeight);
        }
    
        function userNameClick(e){
                        console.log(e);
                        dialog(e.target, $(e.target).data("name"),
                            "Was willst du tun?",
                            [{
                                name:"challenge", 
                                title:"Herausfordern", 
                                do:function(e){
                                   if(me != null) {
                                        socket.emit('challenge', enc({to: $(this).data('name')}));
                                    }else{
                                        dialog($("#sectLogin"), "You're not Logged In!", "Du musst eingeloggt sein, um einen anderen Spieler herrauszufordern.");
                                    }
                                }
                            },{
                                name:"abort",
                                title:"Abbrechen", 
                                do:function(e){}
                            }]
                            );
        }   
        /**
         Shows a dialog popup
         @param: string title
         @param: string text Text to show
         @param: object buttons what do do [{name:name, title:title, do:function()}]
         */
        function dialog(ctx,title, text, b){
            var buttons = [];
            $(b).each(function(i, e){
                var button = $("<button>").addClass(e.name).text(e.title); 
                buttons.push(button);
                button.click(function(){
                    if(e.do != undefined && typeof e.do == 'function') {
                        e.do.call(ctx);
                        var api = $(ctx).data("overlay");
                        api.close();
                    }
                });

            });
            
            var dialog = $("<div>").addClass("modal").
            append($("<h2>").text(title)).
            append($("<p>").text(text)).
            append($("<p>").append(buttons));

            $("body").append(dialog);
            $(ctx).overlay({target:dialog,load: true})
            return ctx;

        }
        function hideURLbar() {
            if (window.location.hash.indexOf('#') == -1) {
                window.scrollTo(0, 1);
            }
        }

        if (navigator.userAgent.indexOf('iPhone') != -1 || navigator.userAgent.indexOf('Android') != -1) {
            addEventListener("load", function() {
                    setTimeout(hideURLbar, 0);
            }, false);
        }
        socket.on('Log', function (msg) {
            log("[SERVER] " + dec(msg).title, enc(dec(msg).payload));
        });
        $(document).ready(function(){
            socket.emit('get users');
            $("#userList").css({'height':$(window).height()});

            $("#login").click(function(e) {
                var nick = $("#nick").val();
                socket.emit('login', enc({"nick": nick}));
                e.preventDefault();
            });
            $("#send").click(function(e) {
                var text = $("#text").val();
                var to = null;

                show(text, "You");
                socket.emit('say', enc({text: text}));
                e.preventDefault();
            });

        });

        /*
            Sockets
        */        
        socket.on('Nick Not Allowed', function (msg) {
            dialog($("#sectLogin"), "Nick: "+dec(msg).nick + "not ok!",
                            "Reason: " + dec(msg).reason);
        });

        socket.on('User Joined', function (msg) {
            var nick = dec(msg).nick;
            users[nick] = new User(nick);

            $("#users").append($("<li id='user-"+nick.replace(/ /g,"_")+"' data-name='"+nick+"''><span>" + nick + "</span></li>").touchClick(function(e){userNameClick(e)}).click(function(e){userNameClick(e)}));
        });

        socket.on('User Left', function (msg) {
            var nick = dec(msg).nick;
            delete users[nick];
            $("#user-" + nick.replace(/ /g,"_")).remove();
        });

        socket.on('Fight Started', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].startFight;
                $("#user-" + fighter.challenger.replace(/ /g,"_")).addClass("inFight");
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].startFight;
                $("#user-" + fighter.defendant.replace(/ /g,"_")).addClass("inFight");
            }
        });
        socket.on('Fight Finished', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].finishedFight;
                $("#user-" + fighter.challenger).removeClass("inFight");
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].finishedFight;
                $("#user-" + fighter.defendant).removeClass("inFight");
            }
        });

        socket.on('Users', function (msg) {
            var list = dec(msg).users;
            var fighters = dec(msg).fighters;
            for (var i = 0; i < list.length; ++i) {
                users[list[i]] = new User(list[i]);
                if ($.inArray(list[i], fighters)) users[list[i]].startFight();
            };
            $.each(users, function(key, val){
                 $("#users").append(
                    $("<li id='user-"+val.name.replace(/ /g,"_")+"' data-name='"+val.name+"'><span>" + val.name + "</span></li>").touchClick(function(e){userNameClick(e)}).click(function(e){userNameClick(e)})
                );
            });

        });

        socket.on('Login', function (msg) {
            var nick = dec(msg).nick;
            me = nick;
            show("Welcome, " + nick + "!");
            $("#header .user").append($("<a>").text(nick));
            $("#header .user").prepend($("<img>").attr({'src':"http://unicornify.appspot.com/avatar/"+ $.md5(nick)+"?s=25"}));

            $("#sectLogin").hide();
            $("#sectLobby").show();
        });

        socket.on('Incoming Challenge', function (msg) {

            dialog($("#sectLobby"), dec(msg).from + "has challenged you!",
                            "Willst du gegen ihn antreten?",
                            [
                            {name:"accept", title:"Ja", do:function(e){
                                socket.emit('challenge accepted', "");
                                }
                            },{name:"decline",title:"Nein", do:function(e){
                                socket.emit('challenge declined', "");
                                }
                            }]
                            );
        });
        socket.on('Challenge Declined', function (msg) {
            show("Challenge declined: " + dec(msg).reason);
            var ctx = dialog($("#sectLobby"), "Challenge declined!",
                            "Reason: " + dec(msg).reason);
            setTimeout(function() {$(ctx).data("overlay").close();}, 1000);
        });
        //fight
        socket.on('Init Fight', function (msg) {
            var fight = dec(msg).fight;
            openArena();
        });
        function openArena() {
            hideOptions();
            $("#lobby").hide();
            $("#arena").show();
        }

        function closeArena() {
            $("#lobby").show();
            $("#arena").hide();
        }

        function showOptions(opponent, challengeText, options, callback) {
            var challenge = $("#challenge");
            challenge.find(".opponent").text(opponent);
            challenge.find(".message").text(challengeText);

            $("#options li").each(function (i, opt) {
                $o = $(opt);
                $o.show();
                $o.text(options[i]);
                $o.click(function() { callback(i); });
            });
        }

        function hideOptions() {
            var challenge = $("#challenge");
            challenge.find(".opponent").text(" ");
            challenge.find(".message").text("Warte auf den Angriff deines Gegners!");

            $("#options li").each(function (index, opt) {
                $o = $(opt);
                $o.hide();
                $o.text(" ");
                $o.off("click");
            });
        }

        socket.on('Choose Attack', function (msg) {
            var fight = dec(msg);
            var options = fight.attackOptions;
            showOptions("", "Wähle deinen Angriff!", options, function(i) {
                socket.emit('attack', enc({option: i}));
                hideOptions();
            });
        });

        socket.on('Choose Answer', function (msg) {
            var decoded = dec(msg);
            var options = decoded.options;

            showOptions(opponent(nick), decoded.attack, options, function(i) {
                socket.emit('respond', enc({option: i}));
                hideOptions();
            });
        });

        function hearts(hitpoints) {
            var hearts = "";
            for (var i = 0; i < hitpoints; ++i) {
                hearts += "♥";
            }
            return hearts;
        }

        socket.on('Turn Result', function (msg) {
            var decoded = dec(msg);
            var fight = decoded.fight;

            console.log("Turn result: %o", fight);
            var challenger = fight.challenger + " " + hearts(fight.hitpoints[fight.challenger]);
            var defendant = fight.defendant + " " + hearts(fight.hitpoints[fight.defendant]);

            $("#challengerStatus").text(challenger);
            $("#defendantStatus").text(defendant);

            var defended = decoded.defended;

        });

        socket.on('Fight Result', function (msg) {
            closeArena();
            var fight = dec(msg);
            if (fight.hitpoints[nick] == 0) {
                show("\nYou lost!");
            }
            else {
                show("\nYou won!");
            }
        });

        // FIGHT Broadcast events ///////////////////////////////////////////////////////////////

        socket.on('Fight Started', function (msg) {
            var fight = dec(msg);
            show("Fight started between " + fight.challenger + " and " + fight.defendant);
        });

        socket.on('Fight Ended', function (msg) {
            var decoded = dec(msg);
            var fight = decoded.fight;
            show("Fight between " + fight.challenger + " and " + fight.defendant + " ended " +
                    fight.hitpoints[fight.challenger] + ":" + fight.hitpoints[fight.defendant]);
            show("Winner " + decoded.winner + " has new score " + decoded.winnerWins);
        });

        function opponent(fight, nick) {
            return (fight.challenger == nick) ? fight.defendant : fight.challenger;
        }

        
    </script>
<div data-role="page">

    <div data-role="header" id="header">
        <div class="title"><h1>PiratenKampf</h1></div>
        <div class="userDiv">
            <div class="user">
            </div>
        </div>
    </div><!-- /header -->

    <div data-role="content" id="lobby">
        <div class="content">
            <section id="sectLogin">
            
                <form>
                    <label for="nick">Wie ist dein Name Landratte?</label><input type="text" id="nick" /><br />
                    <button id="login">EnteRRR!</button>
                </form>            
            </section>

            <section id="sectLobby" style="display: none;" class="ui-grid-a">
                <form>
                    <textarea id="messages" rows="10" cols="40" autocomplete="off" readonly></textarea></br>
                    <label for="text">Deine Nachricht Matrose</label><input type="text" id="text"/><br />
                    <button id="send">Shout! Like a pirate</button>
                </form>
            </section>
        </div>
        <div id="aside">
            <div id="userList">
                <ul id="users" ></ul>
            </div>
        </div>
    </div><!-- /content -->
    <div data-role="content" id="arena" style="display:none;">
        <div id="challenge">
            <span class="opponent"></span>
            <span class="message"></span>
        </div>
        <div id="picture">
            <div class="status" id="challengerStatus"></div>
            <div class="status" id="defendantStatus"></div>
        </div>
        <ul id="options">
            <li id="o1"></li>
            <li id="o2"></li>
            <li id="o3"></li>
        </ul>
    </div>

</div><!-- /page -->
</body>
</html>