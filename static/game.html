<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lobby</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <link rel="stylesheet/less" type="text/css" href="stylesheets/game.less">
    <script src="/less.min.js" type="text/javascript"></script>
    <script src="jquery.md5.js" type="text/javascript"></script>
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect('http://' + location.host + '/chat');

        var users = {};


        /**
         User Model
         Repsresents a User
         @param string nick: nickname
         */
        function User(nick) {
            this.fights = false;
            this.name = nick;
            this.startFight = function() {
                this.fights = true;
            }
            this.finishedFight = function() {
                this.fights = false;
            }
        }

        /* GENERAL */
        function enc(object) { return JSON.stringify(object); }
        function dec(str) { return JSON.parse(str); }

        function doLog(level, title, msg) {
            console.log(title + ": " + enc(msg));
        }

        function log(title, msg) {
            doLog("DEBUG", title, msg);
        }

        function err(title, msg) {
            doLog("ERROR", title, msg);
        }

        function show(text, user) {
            if (user != null) text = user + ": " + text;
            // doLog("DEBUG", "Write", text);
            var $out = $("#messages");
            $out.val($out.val() + text + "\n");
            $out.scrollTop($out[0].scrollHeight);
        }
        /**
         Shows a dialog popup
         @param: string title
         @param: string text Text to show
         @param: object buttons what do do [{name:name, title:title, do:function()}]
         */
        function dialog(title, text, buttons){
            var buttons = [];
            $(buttons).each(function(i, e){
                var button = $("<button>").addClass(e.name).text(e.title); 
                buttons.push = button;
                button.onClick(e.do);

            });
            var dialog = $("<div>").addClass("modal").
            append($("<h2>").text(title)).
            append($("<p>").text(text)).
            append($("<p>").append(buttons));


        }

        socket.on('Log', function (msg) {
            log("[SERVER] " + dec(msg).title, enc(dec(msg).payload));
        });
        $(document).ready(function(){
            socket.emit('get users');
            $("#aside").css({'height':$(window).height()});
            $("#login").click(function(e) {
                var nick = $("#nick").val();
                socket.emit('login', enc({"nick": nick}));
                e.preventDefault();
            });
        

        });

        /*
            Sockets
        */        
        socket.on('Nick Not Allowed', function (msg) {
            dialog("Nick '" + dec(msg).nick + "' not ok! Reason: " + dec(msg).reason);
        });

        socket.on('User Joined', function (msg) {
            var nick = dec(msg).nick;
            users[nick] = new User(nick);

            $("#users").append($("<li id='user-"+nick+"'>" + nick + "</li>"));
        });

        socket.on('User Left', function (msg) {
            var nick = dec(msg).nick;
            delete users[nick];
            $("#user-" + nick).delete();
        });

        socket.on('Fight Started', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].startFight;
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].startFight;
            }
        });
        socket.on('Fight Finished', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].finishedFight;
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].finishedFight;
            }
        });

        socket.on('Users', function (msg) {
            var list = dec(msg).users;
            console.log(dec(msg));
            var fighters = dec(msg).fighters;
            for (var i = 0; i < list.length; ++i) {
                users[list[i]] = new User(list[i]);
                console.log(users);
                if ($.inArray(list[i], fighters)) users[list[i]].startFight();
            };
            $.each(users, function(key, val){
                console.log(typeof e);
                if(typeof e != "undefined") $("#users").append($("<li id='user-"+val.name+"'>" + val.name + "</li>"));
            });
        });

        socket.on('Login', function (msg) {
            var nick = dec(msg).nick;
            show("Welcome, " + nick + "!");
            $("#header .user").append($("<a>").text(nick));
            $("#header .user").prepend($("<img>").attr({'src':"http://unicornify.appspot.com/avatar/"+ $.md5(nick)+"?s=25&v=3"}));

            $("#sectLogin").hide();
            $("#sectLobby").show();
        });

        
    </script>
<div data-role="page">

    <div data-role="header" id="header">
        <div class="title"><h1>PiratenKampf</h1></div>
        <div class="userDiv">
            <div class="user">
            </div>
        </div>
    </div><!-- /header -->

    <div data-role="content">
        <div class="content">
            <section id="sectLogin">
            
                <form>
                    <label for="nick">Nickname</label><input type="text" id="nick" />
                    <button id="login">Go to Lobby!</button>
                </form>            
            </section>

            <section id="sectLobby" style="display: none;" class="ui-grid-a">
                <form class="ui-block-a">
                    <textarea id="messages" rows="10" cols="40" autocomplete="off" readonly></textarea></br>
                    <label for="text">Message</label><input type="text" id="text"/>
                    <button id="send">SEND</button>
                </form>
            </section>
        </div>
        <div id="aside">
                <ul id="users" ></ul>
            </div>
    </div><!-- /content -->

</div><!-- /page -->
</body>
</html>