<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lobby</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <link rel="stylesheets/less" type="text/css" href="game.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.3.1/less.min.js " type="text/javascript"></script>
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect('http://' + location.host + '/chat');
        /* GENERAL */
        function enc(object) { return JSON.stringify(object); }
        function dec(str) { return JSON.parse(str); }

        function doLog(level, title, msg) {
            console.log(title + ": " + enc(msg));
        }

        function log(title, msg) {
            doLog("DEBUG", title, msg);
        }

        function err(title, msg) {
            doLog("ERROR", title, msg);
        }

        function show(text, user) {
            if (user != null) text = user + ": " + text;
            // doLog("DEBUG", "Write", text);
            var $out = $("#messages");
            $out.val($out.val() + text + "\n");
            $out.scrollTop($out[0].scrollHeight);
        }
        /**
         Shows a dialog popup
         @param: string title
         @param: string text Text to show
         @param: object buttons what do do [{name:name, title:title, do:function()}]
         */
        function dialog(title, text, buttons){
            var buttons = [];
            $(buttons).each(function(i, e){
                var button = $("<button>").addClass(e.name).text(e.title); 
                buttons[] = button;
                button.onClick(e.do);

            });
            var dialog = $("<div>").addClass("modal").
            append($("<h2>").text(title)).
            append($("<p>").text(text)).
            append($("<p>").append())

        }

        socket.on('Log', function (msg) {
            log("[SERVER] " + dec(msg).title, enc(dec(msg).payload));
        });
        $(document).ready(function(){
            socket.emit('get users');

            $("#login").click(function(e) {
                var nick = $("#nick").val();
                socket.emit('login', enc({"nick": nick}));
                e.preventDefault();
            });
        

        });

        /*
            Sockets
        */        
        socket.on('Users', function (msg) {
            var list = dec(msg).users;
            for (var i = 0; i < list.length; ++i) {
               $("#users").append($("<li>" + list[i] + "</li>"));
            }
            $("#users").listview('refresh');
        });
        socket.on('Nick Not Allowed', function (msg) {
            dialog("Nick '" + dec(msg).nick + "' not ok! Reason: " + dec(msg).reason);
        });

        socket.on('User Joined', function (msg) {
            var nick = dec(msg).nick;
            show(nick + " joined.");
            $("#users").append($("<li>" + nick + "</li>")).listview('refresh');
        });

        socket.on('User Left', function (msg) {
            var nick = dec(msg).nick;
            show(nick + " left.");
            var $u = $("#users").find("li");
            $u.each(function (i, el) {
                if (el.firstChild.data == nick) {
                    el.parentNode.removeChild(el)
                }
            });
            $("#users").listview('refresh');
        });

        socket.on('Users', function (msg) {
            var list = dec(msg).users;
            for (var i = 0; i < list.length; ++i) {
               $("#users").append($("<li>" + list[i] + "</li>"));
            }
            $("#users").listview('refresh');
        });

        socket.on('Login', function (msg) {
            var nick = dec(msg).nick;
            show("Welcome, " + nick + "!");
            $("#sectLogin").hide();
            $("#sectMain").show();
        });

    </script>
<div data-role="page">

    <div data-role="header">
        <h1>DEATH CHAT</h1>
    </div><!-- /header -->

    <div data-role="content">

        <section id="sectLogin"><form>
            <label for="nick">Login</label><input type="text" id="nick" />
            <button id="login">STERP!</button>
        </form></section>

        <section id="sectMain" style="display: none;" class="ui-grid-a">
            <form class="ui-block-a">
                <textarea id="messages" rows="10" cols="40" autocomplete="off" readonly></textarea></br>
                <label for="text">Message</label><input type="text" id="text"/>
                <button id="send">SEND</button>
            </form>
            <div class="ui-block-b">
                <ul id="users" data-role="listview" ></ul>
            </div>
        </section>


        <p>Hello world</p>
    </div><!-- /content -->

</div><!-- /page -->
</body>
</html>