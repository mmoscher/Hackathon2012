<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lobby</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <link rel="stylesheet/less" type="text/css" href="stylesheets/game.less">
    <script src="/less.min.js" type="text/javascript"></script>
    <script src="jquery.md5.js" type="text/javascript"></script>
    <script src="jquery.touchclick.min.js" type="text/javascript"></script>
    <script src="jquery.tools.min.js" type="text/javascript"></script>
</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var socket = io.connect('http://' + location.host + '/chat');

        var users = {};
        var me = null;


        /**
         User Model
         Repsresents a User
         @param string nick: nickname
         */
        function User(nick) {
            this.fights = false;
            this.name = nick;

            this.startFight = function() {
                this.fights = true;
            }
            this.finishedFight = function() {
                this.fights = false;
            }
        }

        /* GENERAL */
        function enc(object) { return JSON.stringify(object); }
        function dec(str) { return JSON.parse(str); }

        function doLog(level, title, msg) {
            console.log(title + ": " + enc(msg));
        }

        function log(title, msg) {
            doLog("DEBUG", title, msg);
        }

        function err(title, msg) {
            doLog("ERROR", title, msg);
        }

        function show(text, user) {
            if (user != null) text = user + ": " + text;
            // doLog("DEBUG", "Write", text);
            var $out = $("#messages");
            $out.val($out.val() + text + "\n");
            $out.scrollTop($out[0].scrollHeight);
        }
        function challenge(e){
            if(me != null)
                socket.emit('challenge', enc({to: $(e.target).data('name')}));
        }
        function userNameClick(e){
                        dialog(e.target, $(e.target).data("name"),
                            "Was willst du tun?",
                            [
                            {name:"challenge", title:"Herausfordern", do:function(e){
                                console.log("challenge");
                                }
                            },{name:"pm",title:"Private Nachricht", do:function(e){
                                console.log(e);
                                }
                            }]
                            );
        }   
        /**
         Shows a dialog popup
         @param: string title
         @param: string text Text to show
         @param: object buttons what do do [{name:name, title:title, do:function()}]
         */
        function dialog(ctx,title, text, b){
            var buttons = [];
            $(b).each(function(i, e){
                var button = $("<button>").addClass(e.name).text(e.title); 
                buttons.push(button);
                button.click(function(){
                    if(e.do != undefined && typeof e.do == 'function') e.do(ctx);
                });

            });
            console.log(buttons);
            var dialog = $("<div>").addClass("modal").
            append($("<h2>").text(title)).
            append($("<p>").text(text)).
            append($("<p>").append(buttons));

            $("body").append(dialog);
            $(ctx).overlay({target:dialog,load: true})


        }
        function hideURLbar() {
            if (window.location.hash.indexOf('#') == -1) {
                window.scrollTo(0, 1);
            }
        }

        if (navigator.userAgent.indexOf('iPhone') != -1 || navigator.userAgent.indexOf('Android') != -1) {
            addEventListener("load", function() {
                    setTimeout(hideURLbar, 0);
            }, false);
        }
        socket.on('Log', function (msg) {
            log("[SERVER] " + dec(msg).title, enc(dec(msg).payload));
        });
        $(document).ready(function(){
            socket.emit('get users');
            $("#userList").css({'height':$(window).height()});

            $("#login").click(function(e) {
                var nick = $("#nick").val();
                socket.emit('login', enc({"nick": nick}));
                e.preventDefault();
            });
            $("#send").click(function(e) {
                var text = $("#text").val();
                var to = null;

                // Challenge:
                if (text.indexOf("/challenge ") == 0) {
                    var parts = text.split(" ", 2);
                    to = parts[1];

                    if (to != null) {
                        show("You challenged ", to);
                        socket.emit('challenge', enc({to: to}));
                    }
                }
                // Private Message:
                else if (text.indexOf("/pm ") == 0) {
                    var parts = text.split(" ", 3);
                    to = parts[1];
                    text = parts[2];

                    if (to != null) {
                        show(text, "Private to " + to);
                        socket.emit('whisper', enc({text: text, to: to}));
                    }
                }
                else {
                    show(text, "You");
                    socket.emit('say', enc({text: text}));
                }
                e.preventDefault();
            });

        });

        /*
            Sockets
        */        
        socket.on('Nick Not Allowed', function (msg) {
            dialog("Nick '" + dec(msg).nick + "' not ok! Reason: " + dec(msg).reason);
        });

        socket.on('User Joined', function (msg) {
            var nick = dec(msg).nick;
            users[nick] = new User(nick);

            $("#users").append($("<li id='user-"+nick+"'>" + nick + "</li>"));
        });

        socket.on('User Left', function (msg) {
            var nick = dec(msg).nick;
            delete users[nick];
            $("#user-" + nick).remove();
        });

        socket.on('Fight Started', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].startFight;
                $("#user-" + fighter.challenger).addClass("inFight");
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].startFight;
                $("#user-" + fighter.defendant).addClass("inFight");
            }
        });
        socket.on('Fight Finished', function(msg){
            var fighter = dev(msg).fight;
            if(typeof users[fighter.challenger] != 'undefined'){
                users[fighter.challenger].finishedFight;
                $("#user-" + fighter.challenger).removeClass("inFight");
            }
            if(typeof users[fighter.defendant] != 'undefined'){
                users[fighter.defendant].finishedFight;
                $("#user-" + fighter.defendant).removeClass("inFight");
            }
        });

        socket.on('Users', function (msg) {
            var list = dec(msg).users;
            var fighters = dec(msg).fighters;
            for (var i = 0; i < list.length; ++i) {
                users[list[i]] = new User(list[i]);
                if ($.inArray(list[i], fighters)) users[list[i]].startFight();
            };
            $.each(users, function(key, val){
                 $("#users").append(
                    $("<li id='user-"+val.name+"' data-name="+val.name+">" + val.name + "</li>").touchClick(function(e){userNameClick(e)}).click(function(e){userNameClick(e)})
                );
            });

        });

        socket.on('Login', function (msg) {
            var nick = dec(msg).nick;
            me = nick;
            show("Welcome, " + nick + "!");
            $("#header .user").append($("<a>").text(nick));
            $("#header .user").prepend($("<img>").attr({'src':"http://unicornify.appspot.com/avatar/"+ $.md5(nick)+"?s=25&v=3"}));

            $("#sectLogin").hide();
            $("#sectLobby").show();
        });

        
    </script>
<div data-role="page">

    <div data-role="header" id="header">
        <div class="title"><h1>PiratenKampf</h1></div>
        <div class="userDiv">
            <div class="user">
            </div>
        </div>
    </div><!-- /header -->

    <div data-role="content">
        <div class="content">
            <section id="sectLogin">
            
                <form>
                    <label for="nick">Nickname</label><input type="text" id="nick" />
                    <button id="login">Go to Lobby!</button>
                </form>            
            </section>

            <section id="sectLobby" style="display: none;" class="ui-grid-a">
                <form class="ui-block-a">
                    <textarea id="messages" rows="10" cols="40" autocomplete="off" readonly></textarea></br>
                    <label for="text">Message</label><input type="text" id="text"/>
                    <button id="send">SEND</button>
                </form>
            </section>
        </div>
        <div id="aside">
            <div id="userList">
                <ul id="users" ></ul>
            </div>
        </div>
    </div><!-- /content -->

</div><!-- /page -->
</body>
</html>